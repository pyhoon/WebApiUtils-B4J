Public Sub Initialize
	App = Main.App
	HRM.Initialize
	Main.SetApiMessage(HRM)
	DB.Initialize(Main.DBType, Null)
End Sub
$end$
Sub Handle (req As ServletRequest, resp As ServletResponse)
	Request = req
	Response = resp
	Method = Request.Method.ToUpperCase
	Dim FullElements() As String = WebApiUtils.GetUriElements(Request.RequestURI)
	Elements = WebApiUtils.CropElements(FullElements, 3) ' 3 For Api handler
	If ElementMatch("") Then
		If App.MethodAvailable2(Method, "/api/$endpoints$", Me) Then
			Select Method
				Case "GET"
					Get$EndPoints$
					Return
				Case "POST"
					Post$EndPoint$
					Return
			End Select
		End If
		ReturnMethodNotAllow
		Return
	Else If ElementMatch("id") Then
		If App.MethodAvailable2(Method, "/api/$endpoints$/*", Me) Then
			Select Method
				Case "GET"
					Get$EndPoint$ById(ElementId)
					Return
				Case "PUT"
					Put$EndPoint$ById(ElementId)
					Return
				Case "DELETE"
					Delete$EndPoint$ById(ElementId)
					Return
			End Select
		End If
		ReturnMethodNotAllow
		Return
	End If
	ReturnBadRequest
End Sub

Private Sub ElementMatch (Pattern As String) As Boolean
	Select Pattern
		Case ""
			If Elements.Length = 0 Then
				Return True
			End If
		Case "id"
			If Elements.Length = 1 Then
				If IsNumber(Elements(0)) Then
					ElementId = Elements(0)
					Return True
				End If
			End If
	End Select
	Return False
End Sub

Private Sub ReturnApiResponse
	WebApiUtils.ReturnHttpResponse(HRM, Response)
End Sub

Private Sub ReturnBadRequest
	WebApiUtils.ReturnBadRequest(HRM, Response)
End Sub

Private Sub ReturnMethodNotAllow
	WebApiUtils.ReturnMethodNotAllow(HRM, Response)
End Sub

Private Sub Get$EndPoints$
	DB.Initialize(Main.DBType, Main.DBOpen)
	DB.Table = "$TableName$"
	DB.Query
	HRM.ResponseCode = 200
	HRM.ResponseData = DB.Results
	ReturnApiResponse
	DB.Close
End Sub

Private Sub Get$EndPoint$ById (Id As Int)
	DB.Initialize(Main.DBType, Main.DBOpen)
	DB.Table = "$TableName$"
	DB.Find(Id)
	If DB.Found Then
		HRM.ResponseCode = 200
		HRM.ResponseObject = DB.First
	Else
		HRM.ResponseCode = 404
		HRM.ResponseError = "$EndPoint$ not found"
	End If
	ReturnApiResponse
	DB.Close
End Sub

Private Sub Post$EndPoint$
	Dim data As Map
	Dim payload As String
	If HRM.ContentType = WebApiUtils.MIME_TYPE_XML Then
		payload = "xml"
		data = WebApiUtils.RequestDataXml(Request)
		data = data.Get("root")
	Else
		payload = "json"
		data = WebApiUtils.RequestDataJson(Request)
	End If
	If Not(data.IsInitialized) Then
		HRM.ResponseCode = 400
		HRM.ResponseError = $"Invalid ${payload} object"$
		ReturnApiResponse
		Return
	End If

	' Check whether required keys are provided
	Dim RequiredKeys As List = Array As String("key1", "key2", "key3")
	For Each requiredkey As String In RequiredKeys
		If data.ContainsKey(requiredkey) = False Then
			HRM.ResponseCode = 400
			HRM.ResponseError = $"Key '${requiredkey}' not found"$
			ReturnApiResponse
			Return
		End If
	Next
	
	' Check conflict $endpoint$ name
	DB.Initialize(Main.DBType, Main.DBOpen)
	DB.Table = "$TableName$"
	DB.Where = Array("$endpoint$_name = ?")
	DB.Parameters = Array As String(data.Get("$endpoint$_name"))
	DB.Query
	If DB.Found Then
		HRM.ResponseCode = 409
		HRM.ResponseError = "$EndPoint$ already exist"
		ReturnApiResponse
		DB.Close
		Return
	End If
	
	' Insert new row
	DB.Reset
	DB.Columns = Array("$endpoint$_name", "created_date")
	DB.Parameters = Array(data.Get("$endpoint$_name"), data.GetDefault("created_date", WebApiUtils.CurrentDateTime))
	DB.Save
	
	' Retrieve new row
	HRM.ResponseCode = 201
	HRM.ResponseObject = DB.First
	HRM.ResponseMessage = "$EndPoint$ created successfully"
	ReturnApiResponse
	DB.Close
End Sub

Private Sub Put$EndPoint$ById (Id As Int)
	Dim payload As String
	Dim data As Map
	If HRM.ContentType = WebApiUtils.MIME_TYPE_XML Then
		payload = "xml"
		data = WebApiUtils.RequestDataXml(Request)
		data = data.Get("root")
	Else
		payload = "json"
		data = WebApiUtils.RequestDataJson(Request)
	End If
	If Not(data.IsInitialized) Then
		HRM.ResponseCode = 400
		HRM.ResponseError = $"Invalid ${payload} object"$
		ReturnApiResponse
		Return
	End If
	
	' Check whether required keys are provided
	If data.ContainsKey("$endpoint$_name") = False Then
		HRM.ResponseCode = 400
		HRM.ResponseError = "Key '$endpoint$_name' not found"
		ReturnApiResponse
		Return
	End If
	
	' Check conflict $endpoint$ name
	DB.Initialize(Main.DBType, Main.DBOpen)
	DB.Table = "$TableName$"
	DB.Where = Array("$endpoint$_name = ?", "id <> ?")
	DB.Parameters = Array As String(data.Get("$endpoint$_name"), Id)
	DB.Query
	If DB.Found Then
		HRM.ResponseCode = 409
		HRM.ResponseError = "$EndPoint$ already exist"
		ReturnApiResponse
		DB.Close
		Return
	End If
	
	DB.Find(Id)
	If DB.Found = False Then
		HRM.ResponseCode = 404
		HRM.ResponseError = "$EndPoint$ not found"
		ReturnApiResponse
		DB.Close
		Return
	End If

	DB.Reset
	DB.Columns = Array("$endpoint$_name", _
	"modified_date")
	DB.Parameters = Array(data.Get("$endpoint$_name"), _
	data.GetDefault("created_date", WebApiUtils.CurrentDateTime))
	DB.Id = Id
	DB.Save

	HRM.ResponseCode = 200
	HRM.ResponseMessage = "$EndPoint$ updated successfully"
	HRM.ResponseObject = DB.First
	ReturnApiResponse
	DB.Close
End Sub

Private Sub Delete$EndPoint$ById (Id As Int)
	DB.Initialize(Main.DBType, Main.DBOpen)
	DB.Table = "$TableName$"
	DB.Find(Id)
	If DB.Found = False Then
		HRM.ResponseCode = 404
		HRM.ResponseError = "$EndPoint$ not found"
		ReturnApiResponse
		DB.Close
		Return
	End If
	
	DB.Reset
	DB.Id = Id
	DB.Delete
	HRM.ResponseCode = 200
	HRM.ResponseMessage = "$EndPoint$ deleted successfully"
	ReturnApiResponse
	DB.Close
End Sub